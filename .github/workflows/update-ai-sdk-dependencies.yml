name: Update AI SDK Dependencies

on:
  schedule:
    # Run at midnight every day (UTC)
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-dependencies:
    name: Update AI SDK Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.17.0'

      - name: Install dependencies
        run: npm install

      - name: Update AI SDK dependencies
        run: |
          # Define the AI SDK packages to update
          packages=(
            "ai"
            "@ai-sdk/provider"
            "@ai-sdk/amazon-bedrock"
            "@ai-sdk/anthropic"
            "@ai-sdk/azure"
            "@ai-sdk/cerebras"
            "@ai-sdk/deepseek"
            "@ai-sdk/google"
            "@ai-sdk/google-vertex"
            "@ai-sdk/groq"
            "@ai-sdk/openai"
            "@openrouter/ai-sdk-provider"
            "@requesty/ai-sdk"
            "ollama-ai-provider-v2"
          )

          # Function to get current major version
          get_major_version() {
            local package=$1
            npm list $package --depth=0 2>/dev/null | grep $package | sed 's/.*@//' | cut -d. -f1
          }

          # Function to get latest version respecting major version
          get_latest_version() {
            local package=$1
            local current_major=$2
            npm view $package version --json | jq -r "select(. | startswith(\"$current_major\"))"
          }

          # Update each package
          for package in "${packages[@]}"; do
            echo "Checking $package..."
            
            # Get current version and major version
            current_version=$(npm list $package --depth=0 --json 2>/dev/null | jq -r ".dependencies[\"$package\"] // empty")
            if [ -z "$current_version" ]; then
              echo "Package $package not found in dependencies, skipping..."
              continue
            fi
            
            current_major=$(echo $current_version | cut -d. -f1)
            echo "Current version: $current_version (major: $current_major)"
            
            # Get latest version with same major
            latest_version=$(npm view $package version --json | jq -r "select(. | startswith(\"$current_major\"))")
            
            if [ "$latest_version" != "$current_version" ]; then
              echo "Updating $package from $current_version to $latest_version"
              npm install $package@$latest_version
            else
              echo "$package is already up to date"
            fi
          done

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update AI SDK dependencies to latest versions"
          title: "chore: update AI SDK dependencies"
          body: |
            ## Automated AI SDK Dependencies Update
            
            This PR updates the following AI SDK packages to their latest versions while maintaining the same major version:
            
            - `ai` - Main Vercel AI SDK package
            - `@ai-sdk/provider` - Base provider package
            - `@ai-sdk/amazon-bedrock` - AWS Bedrock provider
            - `@ai-sdk/anthropic` - Anthropic Claude provider
            - `@ai-sdk/azure` - Azure OpenAI provider
            - `@ai-sdk/cerebras` - Cerebras provider
            - `@ai-sdk/deepseek` - DeepSeek provider
            - `@ai-sdk/google` - Google AI provider
            - `@ai-sdk/google-vertex` - Google Vertex AI provider
            - `@ai-sdk/groq` - Groq provider
            - `@ai-sdk/openai` - OpenAI provider
            - `@openrouter/ai-sdk-provider` - OpenRouter provider
            - `@requesty/ai-sdk` - Requesty provider
            - `ollama-ai-provider-v2` - Ollama provider
            
            The updates respect the current major version to ensure compatibility.
            
            ---
            
            ðŸ¤– This PR was created automatically by the [Update AI SDK Dependencies](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.
          branch: chore/update-ai-sdk-dependencies
          delete-branch: true
          labels: |
            dependencies
            automated
          assignees: ${{ github.actor }}